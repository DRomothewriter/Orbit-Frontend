<nav class="navbar">
    <div class="navbar-brand">
        <h1>Orbit</h1>
        <svg viewBox="0 0 24 24" width="50" height="50"
     xmlns="http://www.w3.org/2000/svg" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <defs>
    <radialGradient id="g-planet" cx="40%" cy="35%" r="70%">
      <stop offset="0%" stop-color="#f8f0ff" stop-opacity="0.75"/>
      <stop offset="60%" stop-color="#a855f7" stop-opacity="0.22"/>
      <stop offset="100%" stop-color="#6b21a8" stop-opacity="0.1"/>
    </radialGradient>

    <linearGradient id="g-ring" x1="0" x2="1">
      <stop offset="0" stop-color="#a855f7" stop-opacity="0.12"/>
      <stop offset="0.6" stop-color="#a855f7" stop-opacity="0.06"/>
      <stop offset="1" stop-color="#a855f7" stop-opacity="0.12"/>
    </linearGradient>

    <filter id="f-shadow" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="0.6" stdDeviation="0.6" flood-color="#000" flood-opacity="0.15"/>
    </filter>
  </defs>


  <ellipse cx="12" cy="12" rx="9" ry="3.6" transform="rotate(-20 12 12)"
           fill="url(#g-ring)" stroke="none"/>

  <g filter="url(#f-shadow)">
    <circle cx="12" cy="12" r="5.2" fill="url(#g-planet)" stroke="#a855f7" stroke-width="1.2"/>
  </g>

  <ellipse cx="12" cy="12" rx="9" ry="3.6" transform="rotate(-20 12 12)"
           fill="none" stroke="#a855f7" stroke-width="1.2" stroke-opacity="0.95"
           stroke-linecap="round" stroke-linejoin="round"/>
  <!-- small accent: thin equator line to suggest curvature -->
  <path d="M9.2 14.6c.8-.4 1.8-.6 2.8-.6 1 .0 1.9.2 2.8.6" stroke="#7c2ae8" stroke-width="0.6" stroke-linecap="round" fill="none" opacity="0.5"/>
</svg>

    </div>
    <div class="navbar-menu">
        <button mat-icon-button class="nav-icon" (click)="openCalendarModal()" matTooltip="Calendario">
            <mat-icon>calendar_month</mat-icon>
        </button>
        
        <!-- === BOTÓN DE NOTIFICACIONES === -->
        <div class="dropdown-container" (appClickOutside)="closeNotifications()">
            <button mat-icon-button class="nav-icon relative" (click)="toggleNotifications()" [class.active]="isNotificationsOpen">
                <mat-icon>notifications</mat-icon>
                @if(unreadCount > 0) {
                    <span class="badge">{{ unreadCount }}</span>
                }
            </button>

            <!-- Panel de Notificaciones -->
            @if(isNotificationsOpen) {
                <div class="notifications-dropdown glass-card">
                    <div class="dropdown-header">
                        <span>Notificaciones</span>
                        @if(unreadCount > 0){ <button class="mark-read" (click)="markAsRead()">Limpiar todo</button> }
                    </div>
                    
                    <div class="notifications-list">
                        @for(notif of notifications; track $index) {
                            
                            <!-- Tipo: Solicitud de Amistad -->
                            @if(notif.type === 'friend_request') {
                                <div class="notification-item request">
                                    <div class="notif-avatar">
                                        <img [src]="notif.data.friendId?.profileImgUrl || 'https://placehold.co/40x40/533483/ffffff?text=U'" alt="Avatar">
                                        <div class="icon-badge"><mat-icon>person_add</mat-icon></div>
                                    </div>
                                    <div class="notif-content">
                                        <p class="message">
                                            <strong>{{ notif.data.friendId?.username || 'Usuario' }}</strong> quiere ser tu amigo.
                                        </p>
                                        <div class="actions">
                                            <button class="btn-accept" (click)="acceptRequest(notif.data._id, $event)">Confirmar</button>
                                            <button class="btn-reject" (click)="rejectRequest(notif.data._id, $event)">Borrar</button>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Tipo: Mensaje -->
                            @if(notif.type === 'message') {
                                <div class="notification-item message">
                                    <div class="notif-avatar">
                                        <img [src]="notif.data.avatar" alt="Avatar">
                                        <div class="icon-badge msg"><mat-icon>chat</mat-icon></div>
                                    </div>
                                    <div class="notif-content">
                                        <p class="title"><strong>{{ notif.data.username }}</strong></p>
                                        <p class="text">{{ notif.data.text }}</p>
                                        <span class="time">{{ notif.timestamp | date:'shortTime' }}</span>
                                    </div>
                                </div>
                            }

                        } @empty {
                            <div class="empty-state">
                                <mat-icon>notifications_off</mat-icon>
                                <p>No tienes notificaciones nuevas</p>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
        
        <!-- Botón de Configuración -->
        <div class="dropdown-container" (appClickOutside)="closeSettings()">
            <button mat-icon-button class="nav-icon" (click)="toggleSettings()" [class.active]="isSettingsOpen">
                <mat-icon>settings</mat-icon>
            </button>

            @if(isSettingsOpen) {
                <div class="settings-dropdown glass-card">
                    <div class="dropdown-header">Configuración</div>
                    <ul>
                        <li (click)="handleSettingClick('Cuenta')">
                            <mat-icon>person</mat-icon>
                            <span>Cuenta</span>
                        </li>
                        <li (click)="handleSettingClick('Apariencia')">
                            <mat-icon>palette</mat-icon>
                            <span>Apariencia</span>
                        </li>
                        <li (click)="handleSettingClick('Notificaciones')">
                            <mat-icon>notifications_active</mat-icon>
                            <span>Notificaciones</span>
                        </li>
                        <li (click)="handleSettingClick('Idioma')">
                            <mat-icon>language</mat-icon>
                            <span>Idioma</span>
                        </li>
                        <!-- Botón de Cerrar Sesión REAL -->
                        <li class="danger" (click)="handleLogout()">
                            <mat-icon>logout</mat-icon>
                            <span>Cerrar Sesión</span>
                        </li>
                    </ul>
                </div>
            }
        </div>

        <div class="user-profile" (click)="openMyuserModal()">
            <div class="avatar-container">
                <img
                    [src]="user.profileImgUrl || 'https://placehold.co/40x40/533483/ffffff?text=U'"
                    alt="Usuario"
                    class="profile-pic"
                />
                <span class="status-indicator" [ngClass]="user.status || 'offline'"></span>
            </div>
        </div>
    </div>
</nav>